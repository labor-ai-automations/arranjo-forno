<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arranjo de Forno Inteligente - FAMA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* --- VARI√ÅVEIS E CORES --- */
        :root {
            --color-primary: #D92D20; --color-primary-hover: #B42318;
            --color-success: #10B981; --color-info: #3B82F6;
            --radius-md: 8px; --radius-lg: 12px;
            --font-main: 'Inter', sans-serif;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Temas */
        .light-theme {
            --bg-main: #F9FAFB; --bg-card: #FFFFFF;
            --text-primary: #111827; --text-secondary: #6B7280;
            --border-color: #E5E7EB;
        }
        .dark-theme {
            --bg-main: #111827; --bg-card: #1F2937;
            --text-primary: #F9FAFB; --text-secondary: #9CA3AF;
            --border-color: #374151;
        }

        body {
            font-family: var(--font-main);
            margin: 0;
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- LAYOUT DO CABE√áALHO (CORRIGIDO) --- */
        header {
            display: grid;
            grid-template-columns: 1fr auto 1fr; /* Esquerda, Centro, Direita */
            align-items: center;
            padding: 1rem 2rem;
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .header-left { justify-self: start; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .header-center { justify-self: center; }
        .header-right { justify-self: end; display: flex; align-items: center; gap: 10px; }

        header img { height: 48px; display: block; }

        /* --- BOT√ïES --- */
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: inherit;
        }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: var(--color-primary-hover); }
        .btn-secondary { border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-primary); }
        .btn-secondary:hover { background-color: var(--bg-main); border-color: var(--text-secondary); }
        .btn-success { background-color: var(--color-success); color: white; }
        .btn-info { background-color: var(--color-info); color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* --- ESTRUTURA GERAL --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem 2rem 2rem; }
        .card { background-color: var(--bg-card); border-radius: var(--radius-lg); padding: 1.5rem 2rem; margin-bottom: 2rem; box-shadow: var(--shadow-md); }
        .hidden { display: none !important; }

        /* --- STEPPER --- */
        .stepper { display: flex; justify-content: space-between; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .step { display: flex; align-items: center; color: var(--text-secondary); font-weight: 500; }
        .step.active { color: var(--text-primary); font-weight: 600; }
        .step .step-number { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; margin-right: 0.5rem; font-size: 0.8rem; }
        .step.active .step-number { border-color: var(--color-primary); background-color: var(--color-primary); color: white; }

        /* --- INPUTS & CONFIG --- */
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .btn-group { display: flex; gap: 1rem; margin-top: 0.5rem; }
        .btn-group button { flex: 1; padding: 1rem; border: 1px solid var(--border-color); background: var(--bg-main); color: var(--text-secondary); border-radius: var(--radius-md); cursor: pointer; font-weight: 600; }
        .btn-group button.active { border-color: var(--color-primary); background: rgba(217, 45, 32, 0.1); color: var(--color-primary); }
        
        input[type="text"], select { width: 100%; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: var(--radius-md); border: 1px solid var(--border-color); background-color: var(--bg-main); color: var(--text-primary); box-sizing: border-box;}
        label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); }

        /* --- ARRANJO DRAG & DROP --- */
        .arranjo-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .arranjo-coluna { min-height: 200px; padding: 1rem; border: 2px dashed var(--border-color); border-radius: var(--radius-md); }
        .arranjo-coluna h3 { margin-top: 0; font-size: 1rem; color: var(--text-secondary); text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        
        .item-card { background-color: var(--bg-card); padding: 0.8rem; margin-bottom: 0.8rem; border-radius: var(--radius-md); border-left: 4px solid var(--color-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: grab; position: relative; }
        .item-card p { margin: 3px 0; font-size: 0.9rem; }
        .delete-btn { position: absolute; top: 5px; right: 10px; cursor: pointer; color: var(--text-secondary); font-size: 1.2rem; }
        .delete-btn:hover { color: var(--color-primary); }
        .gt-input { width: 60px !important; padding: 2px !important; margin: 0 !important; display: inline-block; }

        /* --- TABELAS --- */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        th, td { border: 1px solid var(--border-color); padding: 0.75rem; text-align: left; }
        th { background-color: var(--bg-main); }
        
        /* --- MODAL --- */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-card); width: 90%; max-width: 1100px; max-height: 90vh; overflow-y: auto; padding: 2rem; border-radius: var(--radius-lg); position: relative; }
        .modal-close { position: absolute; top: 1rem; right: 1.5rem; font-size: 2rem; cursor: pointer; }
        
        /* --- UTILS --- */
        .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s infinite linear; display: inline-block; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="dark-theme">

    <header>
        <div class="header-left">
            <button id="nav-gerar" class="btn btn-primary">Gerar Arranjo</button>
            <button id="nav-mestre" class="btn btn-secondary">Gerenciar Itens Mestre</button>
            <button id="nav-historico" class="btn btn-secondary">Hist√≥rico</button>
        </div>
        <div class="header-center">
            <img id="logo-fama" src="https://ctfamadobrasil.com.br/wp-content/uploads/2025/12/Gemini_Generated_Image_v8cib8v8cib8v8ci-removebg-preview.png" alt="Logo Fama">
        </div>
        <div class="header-right">
            <span>‚òÄÔ∏è</span> <input type="checkbox" id="theme-toggle" checked> <span>üåô</span>
        </div>
    </header>

    <main id="app-container" class="container">
        <!-- Conte√∫do injetado via JS -->
    </main>

    <!-- TEMPLATES (Escondidos, usados pelo JS) -->
    
    <!-- Template: Gerar Arranjo -->
    <template id="tpl-gerar">
        <div class="stepper">
            <div id="step-nav-1" class="step active"><span class="step-number">1</span>Configura√ß√£o</div>
            <div id="step-nav-2" class="step"><span class="step-number">2</span>Organiza√ß√£o</div>
            <div id="step-nav-3" class="step"><span class="step-number">3</span>Finaliza√ß√£o</div>
        </div>

        <div id="view-step-1" class="card">
            <h2>1. Configura√ß√£o do Forno</h2>
            <div class="config-grid">
                <div>
                    <label>Selecione o Forno</label>
                    <div class="btn-group">
                        <button id="btn-forno-grande" class="active">Forno Grande (1001)</button>
                        <button id="btn-forno-pequeno">Forno Pequeno (1002)</button>
                    </div>
                </div>
                <div>
                    <label id="lbl-config-forno">GTs para Forno Grande</label>
                    <select id="sel-qtde-gts">
                        <option value="1">1 GT</option>
                        <option value="2">2 GTs</option>
                        <option value="3">3 GTs</option>
                    </select>
                    <div id="container-gts-inputs"></div>
                </div>
            </div>
            <div style="margin-top: 2rem; display: flex; gap: 1rem; align-items: center;">
                <input type="file" id="input-csv" accept=".csv" style="display: none;">
                <button id="btn-upload" class="btn btn-secondary">üìÇ Carregar CSV</button>
                <span id="file-name" style="color: var(--text-secondary); font-size: 0.9rem;">Nenhum arquivo</span>
                <button id="btn-processar" class="btn btn-primary" style="margin-left: auto;">üöÄ Gerar Arranjo</button>
            </div>
        </div>

        <div id="view-step-2" class="card hidden">
            <h2>2. Resultado do Arranjo</h2>
            <div class="arranjo-container">
                <div class="arranjo-coluna" id="col-producao">
                    <h3>Arranjo de Produ√ß√£o</h3>
                    <div class="lista-itens" id="lista-producao"></div>
                </div>
                <div class="arranjo-coluna" id="col-pendente">
                    <h3>Itens Pendentes</h3>
                    <div class="lista-itens" id="lista-pendente"></div>
                </div>
            </div>
            <div style="margin-top: 1rem; text-align: right;">
                <button id="btn-avancar" class="btn btn-primary">Avan√ßar para Exporta√ß√£o</button>
            </div>
        </div>

        <div id="view-step-3" class="card hidden">
            <h2>3. Exportar</h2>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button id="btn-export-excel" class="btn btn-success">Baixar Excel</button>
                <button class="btn btn-info" onclick="window.print()">Imprimir / PDF</button>
                <button class="btn btn-secondary" onclick="location.reload()">Novo Arranjo</button>
            </div>
        </div>
    </template>

    <!-- Template: Gerenciador -->
    <template id="tpl-mestre">
        <div class="card">
            <h2>Gerenciador de Itens Mestre</h2>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <input type="text" id="busca-mestre" placeholder="Buscar c√≥digo, bitola ou GT...">
                <button id="btn-add-novo" class="btn btn-success">+ Novo Item</button>
            </div>
            <div style="max-height: 60vh; overflow-y: auto;">
                <table id="tabela-mestre">
                    <thead><tr><th>C√≥digo</th><th>Bitola</th><th>GT</th><th>A√ß√µes</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </template>

    <!-- Template: Hist√≥rico -->
    <template id="tpl-historico">
        <div class="card">
            <h2>Hist√≥rico de Produ√ß√£o</h2>
            <table id="tabela-historico">
                <thead><tr><th>ID</th><th>Data</th><th>Usu√°rio</th><th>Detalhes</th><th>A√ß√µes</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </template>

    <!-- MODAL DETALHES -->
    <div id="modal-detalhes" class="modal-backdrop hidden">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('modal-detalhes').classList.add('hidden')">&times;</span>
            <h2>Detalhes do Arranjo</h2>
            <p id="modal-params" style="color: var(--text-secondary); margin-bottom: 1rem;"></p>
            <div class="arranjo-container">
                <div class="arranjo-coluna"><h3>Produ√ß√£o</h3><div id="modal-lista-prod"></div></div>
                <div class="arranjo-coluna"><h3>Pendentes</h3><div id="modal-lista-pend"></div></div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const SUPABASE_URL = 'https://mqzrlzywqgylffwvtlmg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xenJsenl3cWd5bGZmd3Z0bG1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzExNDcsImV4cCI6MjA3NTc0NzE0N30.YghplsFD3T1Xv0yuLYTdD9Ib5kenXitDMnXAud7TjSY';
        const URL_N8N_GERAR = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/gerar-arranjo';
        const URL_N8N_UPDATE = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/atualizar-itens-mestre';

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- NAVEGA√á√ÉO ---
        const appContainer = document.getElementById('app-container');
        const navBtns = {
            gerar: document.getElementById('nav-gerar'),
            mestre: document.getElementById('nav-mestre'),
            historico: document.getElementById('nav-historico')
        };

        function setView(viewName) {
            // Atualiza bot√µes
            Object.values(navBtns).forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            navBtns[viewName].classList.remove('btn-secondary');
            navBtns[viewName].classList.add('btn-primary');

            // Limpa e injeta template
            appContainer.innerHTML = '';
            const tpl = document.getElementById(`tpl-${viewName}`);
            appContainer.appendChild(tpl.content.cloneNode(true));

            // Inicializa l√≥gica da view
            if(viewName === 'gerar') initGerarArranjo();
            if(viewName === 'mestre') initMestre();
            if(viewName === 'historico') initHistorico();
        }

        // --- L√ìGICA: GERAR ARRANJO ---
        function initGerarArranjo() {
            const btnGrande = document.getElementById('btn-forno-grande');
            const btnPequeno = document.getElementById('btn-forno-pequeno');
            const selQtde = document.getElementById('sel-qtde-gts');
            const divInputs = document.getElementById('container-gts-inputs');
            const btnUpload = document.getElementById('btn-upload');
            const inputFile = document.getElementById('input-csv');
            const btnProcessar = document.getElementById('btn-processar');

            let fornoAtual = 'grande';

            function renderInputs() {
                divInputs.innerHTML = '';
                const qtde = parseInt(selQtde.value);
                for(let i=0; i<qtde; i++) {
                    const inp = document.createElement('input');
                    inp.type = 'text';
                    inp.placeholder = `C√≥digo GT ${i+1}`;
                    divInputs.appendChild(inp);
                }
            }

            // Eventos de Configura√ß√£o
            btnGrande.onclick = () => { 
                fornoAtual = 'grande'; 
                btnGrande.classList.add('active'); btnPequeno.classList.remove('active'); 
                selQtde.innerHTML = '<option value="1">1 GT</option><option value="2">2 GTs</option><option value="3">3 GTs</option>';
                renderInputs();
            };
            btnPequeno.onclick = () => { 
                fornoAtual = 'pequeno'; 
                btnPequeno.classList.add('active'); btnGrande.classList.remove('active'); 
                selQtde.innerHTML = '<option value="1">1 GT</option><option value="2">2 GTs</option>';
                renderInputs();
            };
            selQtde.onchange = renderInputs;

            // Upload
            btnUpload.onclick = () => inputFile.click();
            inputFile.onchange = () => {
                if(inputFile.files[0]) document.getElementById('file-name').textContent = inputFile.files[0].name;
            };

            // Processar
            btnProcessar.onclick = async () => {
                if(!inputFile.files[0]) return alert('Selecione um arquivo CSV!');
                
                const originalText = btnProcessar.innerHTML;
                btnProcessar.innerHTML = '<div class="spinner"></div> Processando...';
                btnProcessar.disabled = true;

                const gts = Array.from(divInputs.querySelectorAll('input')).map(i => i.value).filter(v => v.trim() !== '');
                const formData = new FormData();
                formData.append('file', inputFile.files[0]);
                formData.append('forno', fornoAtual);
                formData.append('gts_selecionados', JSON.stringify(gts));

                try {
                    const res = await fetch(URL_N8N_GERAR, { method: 'POST', body: formData });
                    if(!res.ok) throw new Error('Erro no servidor');
                    const data = await res.json();
                    
                    // Exibir Resultado
                    document.getElementById('view-step-1').classList.add('hidden');
                    document.getElementById('view-step-2').classList.remove('hidden');
                    document.getElementById('step-nav-2').classList.add('active');

                    renderListaItens(document.getElementById('lista-producao'), data.arranjo_producao, false);
                    renderListaItens(document.getElementById('lista-pendente'), data.itens_pendentes, true);
                    
                    // Configurar exporta√ß√£o
                    document.getElementById('btn-avancar').onclick = () => {
                        document.getElementById('view-step-2').classList.add('hidden');
                        document.getElementById('view-step-3').classList.remove('hidden');
                        document.getElementById('step-nav-3').classList.add('active');
                    };

                    document.getElementById('btn-export-excel').onclick = () => {
                        const wb = XLSX.utils.book_new();
                        const wsData = [["OP", "C√≥digo", "Descri√ß√£o", "Bitola", "GT"]];
                        // Coleta dados DOM (simplificado)
                        document.querySelectorAll('#lista-producao .item-card').forEach(card => {
                            wsData.push([card.dataset.op, card.dataset.cod, card.dataset.desc, card.dataset.bitola, card.dataset.gt]);
                        });
                        const ws = XLSX.utils.aoa_to_sheet(wsData);
                        XLSX.utils.book_append_sheet(wb, ws, "Arranjo");
                        XLSX.writeFile(wb, "Arranjo_Producao.xlsx");
                    };

                } catch (err) {
                    alert('Erro: ' + err.message);
                } finally {
                    btnProcessar.innerHTML = originalText;
                    btnProcessar.disabled = false;
                }
            };

            // Inicializa inputs
            renderInputs();
        }

        // --- HELPER: RENDERIZAR ITENS ---
        function renderListaItens(container, itens, editavel) {
            container.innerHTML = '';
            if(!itens || !itens.length) { container.innerHTML = '<p style="text-align:center; color:gray;">Nenhum item.</p>'; return; }

            itens.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-card';
                div.draggable = true;
                
                // Dados para Excel
                div.dataset.op = item.ordemProducao || '';
                div.dataset.cod = item.codigo || '';
                div.dataset.desc = item.descricao || '';
                div.dataset.bitola = item.dimensao || '';
                div.dataset.gt = item.gt || '';

                let gtDisplay = `GT: <b>${item.gt || 'N/A'}</b>`;
                if(editavel) {
                    gtDisplay = `GT: <input type="text" class="gt-input" value="${item.gt || ''}" placeholder="N/A" onkeydown="salvarGt(event, '${item.codigo}', this)">`;
                }

                div.innerHTML = `
                    <span class="delete-btn" onclick="this.parentElement.remove()">√ó</span>
                    <p><strong>OP:</strong> ${item.ordemProducao || '-'}</p>
                    <p><strong>C√≥d:</strong> ${item.codigo || '-'}</p>
                    <p>${item.descricao || ''}</p>
                    <p>Bitola: ${item.dimensao || '-'}</p>
                    <p style="margin-top:5px;">${gtDisplay}</p>
                `;

                // Drag Events simples
                div.ondragstart = (e) => { e.dataTransfer.setData('text/plain', 'dragging'); window.draggedItem = div; div.style.opacity = '0.5'; };
                div.ondragend = () => { div.style.opacity = '1'; window.draggedItem = null; };
                
                container.appendChild(div);
            });

            // Drop Zone Logic
            container.parentElement.ondragover = (e) => { e.preventDefault(); container.parentElement.style.borderColor = 'var(--color-primary)'; };
            container.parentElement.ondragleave = () => { container.parentElement.style.borderColor = 'var(--border-color)'; };
            container.parentElement.ondrop = (e) => {
                e.preventDefault();
                container.parentElement.style.borderColor = 'var(--border-color)';
                if(window.draggedItem) container.appendChild(window.draggedItem);
            };
        }

        // Fun√ß√£o Global para salvar GT inline
        window.salvarGt = async (e, codigo, input) => {
            if(e.key === 'Enter') {
                input.disabled = true;
                input.style.backgroundColor = '#e8f0fe';
                try {
                    await fetch(URL_N8N_UPDATE, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ codigo, gt: input.value })
                    });
                    input.style.backgroundColor = '#d1fae5'; // Verde sucesso
                } catch(err) {
                    alert('Erro ao salvar');
                    input.style.backgroundColor = '#fee2e2'; // Vermelho erro
                } finally {
                    input.disabled = false;
                }
            }
        };

        // --- L√ìGICA: GERENCIADOR MESTRE ---
        async function initMestre() {
            const tbody = document.querySelector('#tabela-mestre tbody');
            const busca = document.getElementById('busca-mestre');
            const btnAdd = document.getElementById('btn-add-novo');

            async function carregar(filtro = '') {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Carregando...</td></tr>';
                let query = supabase.from('itens_mestre').select('*').order('codigo_item', {ascending: true}).limit(50);
                if(filtro) query = query.ilike('codigo_item', `%${filtro}%`);
                
                const { data, error } = await query;
                tbody.innerHTML = '';
                
                if(error || !data.length) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Sem dados.</td></tr>'; return; }

                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.codigo_item}</td>
                        <td><input type="text" value="${row.bitola || ''}"></td>
                        <td><input type="text" value="${row.gt || ''}"></td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="salvarItemMestre(${row.id}, this)">üíæ</button>
                            <button class="btn btn-primary btn-sm" onclick="deletarItemMestre(${row.id}, this)">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            // Fun√ß√µes globais para bot√µes da tabela
            window.salvarItemMestre = async (id, btn) => {
                const tr = btn.closest('tr');
                const inputs = tr.querySelectorAll('input');
                await supabase.from('itens_mestre').update({ bitola: inputs[0].value, gt: inputs[1].value }).eq('id', id);
                alert('Atualizado!');
            };

            window.deletarItemMestre = async (id, btn) => {
                if(confirm('Excluir?')) {
                    await supabase.from('itens_mestre').delete().eq('id', id);
                    btn.closest('tr').remove();
                }
            };

            btnAdd.onclick = async () => {
                const cod = prompt('C√≥digo do novo item:');
                if(cod) {
                    await supabase.from('itens_mestre').insert({ codigo_item: cod });
                    carregar();
                }
            };

            busca.onkeyup = (e) => { if(e.key === 'Enter') carregar(busca.value); };
            carregar();
        }

        // --- L√ìGICA: HIST√ìRICO ---
        async function initHistorico() {
            const tbody = document.querySelector('#tabela-historico tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Carregando...</td></tr>';
            
            const { data } = await supabase.from('arranjos_gerados').select('*').order('created_at', {ascending: false}).limit(20);
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                const dt = new Date(row.created_at).toLocaleString();
                // Tenta extrair par√¢metros
                let params = 'N/A';
                if(row.parametros_usados && row.parametros_usados.forno) {
                    params = `Forno: ${row.parametros_usados.forno}`;
                }

                tr.innerHTML = `
                    <td>${row.id}</td>
                    <td>${dt}</td>
                    <td>${row.usuario || '-'}</td>
                    <td>${params}</td>
                    <td><button class="btn btn-secondary" onclick='abrirDetalhes(${JSON.stringify(row.id)}, ${JSON.stringify(params)}, ${JSON.stringify(row.arranjo_resultado)})'>Ver</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.abrirDetalhes = (id, params, jsonRaw) => {
            const modal = document.getElementById('modal-detalhes');
            document.getElementById('modal-params').textContent = params;
            
            // Tratamento robusto do JSON
            let data = jsonRaw;
            if(typeof data === 'string') { try { data = JSON.parse(data); } catch(e){} }
            // Se veio do n8n pode estar dentro de 'json' ou array
            if(Array.isArray(data) && data[0]?.json) data = data[0].json;
            else if(data?.json) data = data.json;

            renderListaItens(document.getElementById('modal-lista-prod'), data?.arranjo_producao || [], false);
            renderListaItens(document.getElementById('modal-lista-pend'), data?.itens_pendentes || [], false);
            
            modal.classList.remove('hidden');
        };

        // --- EVENTOS INICIAIS ---
        navBtns.gerar.onclick = () => setView('gerar');
        navBtns.mestre.onclick = () => setView('mestre');
        navBtns.historico.onclick = () => setView('historico');

        document.getElementById('theme-toggle').onchange = (e) => {
            document.body.className = e.target.checked ? 'dark-theme' : 'light-theme';
            const logo = document.getElementById('logo-fama');
            logo.src = e.target.checked 
                ? 'https://ctfamadobrasil.com.br/wp-content/uploads/2025/12/Gemini_Generated_Image_v8cib8v8cib8v8ci-removebg-preview.png' 
                : 'https://ctfamadobrasil.com.br/wp-content/uploads/2025/09/logo.png';
        };

        // Inicia na tela principal
        setView('gerar');

    </script>
</body>
</html>
